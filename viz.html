<!DOCTYPE html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.gstatic.com"> 
        <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;900&display=swap" rel="stylesheet">
        <style>
            body {overflow: hidden; background-color: white; height: 100vh; width: 100vw; font-family: 'Lato', sans-serif;}

            #header {position: absolute; left: 5vw; top: 2.5vh; text-align: left; font-weight: 900;}
            #title {color: black; font-size: max(5vmin, 50px);}
            #subtitle {font-size: max(2vmin, 15px); vertical-align: top;}
            #credits {font-weight: 400;}

            #interaction {width: 95vw; height: 20vh; position:absolute; left: 2.5vw; top: 5vh;}

            #wordchoice {position: absolute; bottom: 0vh; left: 10vw;}
            input {height: 3.5vh; width: 40vw; border-radius: 10px; outline: none; border: 0px; background-color: white; padding: 10px 20px; font-size: 35px; margin: 20px 10px 20px 0; color: black;     border-bottom: 10px solid #000;
}
            #noword {text-align: left; color: black; width: 50vmin; font-size: max(1.5vmin, 10px); }

            #wordsuggest {position: absolute; right: 1vw; bottom: 1.5vh; width: 35vw; height: 20vh; margin: auto;}
            #suggestheader {margin-left: 2.5vmin; padding-top: 1.5vmin; height: 5vh}
            #suggesttitle {font-size: max(2.25vmin, 15px); font-weight: 900;}
            #suggestsubtitle {font-size: max(1.25vmin, 5px); font-weight: 400;}


            #visualization {width: 95vw; height: 70vh; position: absolute; left: 2.5vw; bottom: 2.5vh; display: flex; flex-direction: row; justify-content: space-between;}

            #vizcontainer {flex-basis: 0; flex-grow: 2.5;}
            #viz {width: 95%; height: 100%; margin: auto; background-color: white; border-radius: 15px; box-shadow: 0 0 25px 5px rgba(0,0,0,.15);}
            #vizsvg {width: 90%; height: 90%; margin-left: 5%; margin-top: 5%;}

            #extrainfo {flex-basis: 0; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between;}

            #disclaimer {text-align: center;}

            #vocabcontainer {flex-basis: 0; flex-grow: 3; height: 100%; }
            #wordrank {background-color: white; height: 100%; margin: auto; border-radius: 15px; box-shadow: 0 0 25px 5px rgba(0,0,0,.15);}
            #vocabheader {margin-left: 2.5vmin; padding-top: 1.5vmin;}
            #vocabtitle {font-size: max(2.25vmin, 15px); font-weight: 900;}
            #vocabsubtitle {font-size: max(1.25vmin, 5px); font-weight: 400;}
            #vocabulary {list-style: none; margin-left: 5%; width: 90%; height: 45vh; overflow-y: auto; overflow-x: none; }
            #vocabulary::-webkit-scrollbar {
                display: none;
            }
            #vocabulary > li {border-radius: 10px; background-color: #eeeeee; padding: 1vmin; margin-top: 1vmin; width: 90%; font-size: max(1.5vmin, 10px); font-family: sans-serif; font-weight: bold;}
            
            #artistcontainer {flex-basis: 0; flex-grow: 1;}
            #artistinfo {display:flex; flex-direction: column; background-color: white; height: 95%; margin:auto; border-radius: 15px; box-shadow: 0 0 25px 5px rgba(0,0,0,.15);}
            #artistdesc {margin: auto; margin-left: 5%; display: flex; flex-direction: row;}
            #artistimg {height: max(5vmin, 50px);}
            #artistname {margin-left: 5%; text-align: left; font-size: max(2vmin, 10px); font-weight: 900; font-family: sans-serif;}
            #artistuses {margin: auto; margin-left: 5%; white-space: pre; text-align: left; font-size: max(1.5vmin, 10px); font-family: sans-serif;}
            
            #usagecontainer {flex-basis: 0; flex-grow: 2.5;}
            #wordusage {width: 95%; height: 100%; margin: auto; background-color: white; border-radius: 15px; box-shadow: 0 0 25px 5px rgba(0,0,0,.15);}
            #usageheader {margin-left: 2.5vmin; padding-top: 1.5vmin;}
            #usagetitle {color: black; font-size: 5vmin; font-weight: 900;}
            #usagesubtitle {color: black; font-size: 2vmin; vertical-align: top; font-weight: 400;}
            #usagechart {margin-left: 2.5%; height: 85%; width: 95%;}
            
            .chartaxis {
                font-size: max(1.25vmin, 5px);
            }         
            .smallchartaxis {
                font-size: max(1vmin, 4px);
            }
            .chartbar {
                fill: #ccc;
            }
            .artistchartbar {
                fill: #1DB954;
            }
            .suggestchartbar {
                fill: #000;
            }
            .suggestchartbarartist {
                fill: #1DB954;
            }
            .green {
                color: #1DB954;
            }
            .black {
                fill: #000;
            }
            .grey {
                fill: #ccc;
            }
            .line {
                fill: none;
                stroke: #000;
                stroke-width: 5px;
            }

            .greytooltip {
                position: absolute;
                background-color: #ccc;
                color: white;
                font-weight: 400;
                padding: 10px;
                border-radius: 10px;
            }
            .blacktooltip {
                position: absolute;
                background-color: #000;
                color: white;
                font-weight: 400;
                padding: 10px;
                border-radius: 10px;
            }
            .greentooltip {
                position: absolute;
                background-color: #1DB954;
                color: white;
                font-weight: 400;
                padding: 10px;
                border-radius: 10px;
            }
        </style>
    </head>
    <body>
        <div id="header">
            <span id="title">Hip Hop <span class="green">Talks</span></span>
            <br/>
            <span id="subtitle" class="green">An analysis of the most common words used in Hip Hop.</span>
            <br/>
            <span id="credits">Created by Yodahe Alemu and Joshua Verdejo</span>
        </div>

        <div id="interaction">
            <div id="wordchoice" name="wordchoice" onkeyup="handleType()" onsubmit="()=>{e.preventDefault()}">
                <div id="noword">This word is not one of the most used words in Hip Hop.</div>
                <input type="text" id="wordtype" placeholder="Type out a word&hellip;">
            </div>
            <div id="wordsuggest">
                <div id="suggestheader">
                    <span id="suggesttitle">Next Word Suggestions</span>
                    <br/>
                    <span id="suggestsubtitle">Based off of word frequencies from all artists</span>
                </div>
                <svg id="suggestchart"></svg>
            </div>
        </div>

        <div id="visualization">
            <div id="vizcontainer">
                <div id="viz"></div>
            </div>
            <div id="extrainfo">
                <div id="artistcontainer">
                    <div id="artistinfo">
                        <div id="artistdesc">
                            <img id="artistimg">
                            <div id="artistname"></div>
                        </div>
                        <div id="artistuses"></div>
                    </div>
                </div>
                <div id="vocabcontainer">
                    <div id="wordrank">
                        <div id="vocabheader">
                            <span id="vocabtitle">Hip Hop Vocabulary</span>
                            <br/>
                            <span id="vocabsubtitle">Ranked from highest to lowest</span>
                        </div>
                        <div id="vocabulary"></div>
                    </div>
                </div>
            </div>
            <div id="usagecontainer">
                <div id="wordusage">
                    <div id="usageheader">
                        <span id="usagetitle">Word Usage Over Time</span>
                        <br/>
                        <span id="usagesubtitle">How has the word "hello" been used over time?</span>
                    </div>
                    <svg id="usagechart"></svg>
                </div>
            </div>
        </div>
        <!-- <div id="disclaimer">Compiled by taking the top 50 songs per artist on Genius.com.
            <br/>Data slightly skewed due to artist features on records.
            <br/>Some articles removed such as "a" or "the".
            <br/>If sizing is incorrect, enlarge the window.
        </div> -->
        <script src="https://d3js.org/d3.v6.min.js"></script>
        <script>
            const ANIMATION_DURATION = 1000;
            const VOCAB_WORD_COUNT_MAX = 10000;

            // Initialize the svg
            let width = document.getElementById("viz").offsetWidth;
            let height = document.getElementById("viz").offsetHeight;
            // width = height = Math.min(width, height);
            var svg = d3.select("#viz")
                .append("svg")
                .attr("id", "vizsvg")
                .attr("viewBox", [0, 0, width, height]);

            var rappers=[]; // in the form [rapper1, rapper2, rapper3 ...]
            var rapWords={}; // in the form {word: {rapper1: count, rapper2: count ...} ...}
            var topWords={}; // in the form {rapper1: [word1, word2, word3], rapper2: ...}
            var rapperColors={}; // in the form {rapper1: blue, rapper2: red, ...}
            var rapperPics={}; // in the form {rapper1: pic1, rapper2: pic2, ...}
            var rapperImages={};
            var rapperCircles={}; // in the form {rapper1: [circle_svg], rapper2: [circle_svg_2], ...}
            var rapperOutlines={};
            var rapperNames = {};
            var currentWord="hello";
            var currentArtist = "Diddy";
            var selectedArtist = "";

            // Temporal Data
            var yearly_totals={};
            var yearly_artist_counts={};
            for (var i = 1982; i <= 2021; i++) {
                yearly_totals[i.toString()] = 0;
                yearly_artist_counts[i.toString()] = {};
            }

            // Testing if d3 works
            d3.select("#noword")
                .style("opacity", 0);

            // Vocabulary svg
            var vocabulary = d3.select("#vocabulary");

            // Tooltip svg
            var artistimg = d3.select("#artistimg");
            var artistname = d3.select("#artistname");
            var artistuses = d3.select("#artistuses");

            // Read through all the rappers data and create a circle for each rapper 
            d3.csv("rappers.csv", function(data) {
                let rapper = data["Artists"];
                rappers.push(rapper);
                rapperNames[rapper] = data["Actual"];
                rapperPics[rapper] = data["Pictures"];
            }).then(() => {
                // Read through all the words data
                d3.csv("topwords.csv", function(data) {
                    let rapper = data["Artists"];
                    console.log(rapper);
                    let word1 = data["Word1"];
                    let word2 = data["Word2"];
                    let word3 = data["Word3"];
                    topWords[rapper] = [word1, word2, word3];
                }).then(() => {
                    d3.csv("words.csv", function(data) {
                        let word = data["Words"];
                        rapWords[word] = {};
                        for (var i = 0; i < rappers.length; i++) {
                            let rapper = rappers[i];
                            rapWords[word][rapper] = parseInt(data[rapper]);
                        }
                    }).then(() => {
                        rappers.sort();
                        let svgWidth = .9*document.getElementById("viz").offsetWidth;
                        let svgHeight = .9*document.getElementById("viz").offsetHeight;
                        let margin = 0;
                        let minDim = Math.min(svgHeight, svgWidth);
                        let diff = (minDim - 2*margin)/9;
                        let size = .75*diff;
                        for (var i = 0; i < rappers.length; i++) {
                            let rapper = rappers[i];
                            let x = margin + diff*(i%10) + .125*diff;
                            let y = margin + diff*Math.floor(i/10) + .125*diff;
                            if (svgWidth > svgHeight) x += .5*(svgWidth - svgHeight);
                            else y += .5*(svgHeight - svgWidth);

                            let outline = svg.append("rect")
                                .attr("x", x - .125*diff)
                                .attr("y", y - .125*diff)
                                .attr("height", diff)
                                .attr("width", diff)
                                .attr("fill", "#1DB954")
                                .attr("opacity", 0);
                            let circle = svg.append("image")
                                .attr("x", x)
                                .attr("y", y)
                                .attr("height", size)
                                .attr("width", size)
                                .attr("xlink:href", rapperPics[rapper]);
                            svg.append("rect")
                                .attr("x", x - .125*diff)
                                .attr("y", y - .125*diff)
                                .attr("height", diff)
                                .attr("width", diff)
                                .attr('opacity', 0)
                                .on('mouseover', function (d, i) {
                                    circle.attr('opacity', '.5');
                                    if (selectedArtist == "") {
                                        currentArtist = rapper;
                                        updateArtistTooltip();
                                    }
                                })
                                .on('mouseout', function (d, i) {
                                    circle.transition()
                                        .duration(ANIMATION_DURATION/2)
                                        .attr('opacity', '1');	
                                })
                                .on('click', function(d, i) {
                                    if (selectedArtist != rapper) {
                                        if (selectedArtist != "") {
                                            rapperOutlines[selectedArtist].transition()
                                                .duration(ANIMATION_DURATION/2)
                                                .attr('opacity', 0);
                                        }
                                        rapperOutlines[rapper].transition()
                                            .duration(ANIMATION_DURATION/2)
                                            .attr('opacity', 1);
                                        selectedArtist = rapper;
                                        currentArtist = rapper;
                                        selectArtist();
                                    } else {
                                        rapperOutlines[rapper].transition()
                                            .duration(ANIMATION_DURATION/2)
                                            .attr('opacity', 0);
                                        selectedArtist = "";
                                        deselectArtist();
                                    }
                                });

                            rapperCircles[rapper] = circle;
                            rapperOutlines[rapper] = outline;
                        }

                        updateArtistTooltip();
                        updateCircleSizes(currentWord);

                        // Generate the word sums list
                        let wordsums = {}
                        let vocabwords = []
                        d3.csv("wordsums.csv", function(data) {
                            let rapper = data["Artists"];
                            rappers.push(rapper);
                            rapperPics[rapper] = data["Pictures"];
                            let word = data["Words"];
                            let count = data["Count"];
                            wordsums[word] = count;
                            if (count < VOCAB_WORD_COUNT_MAX) vocabwords.push(word);
                        }).then(() => {
                            vocabwords.sort((a,b) => {return wordsums[b] - wordsums[a]});
                            for (var i = 0; i < vocabwords.length; i++) {
                                let word = vocabwords[i];
                                vocabulary.append("li")
                                    .html("#" + (i+1) + " \"" + word + "\" <span style=\"font-size: max(1.5vmin, 10px); font-weight: normal;\">(" + wordsums[word] + " uses)</span>")
                                    .on('mouseover', function (d, i) {
                                        d3.select(this).transition()
                                            .style('opacity', '.5');
                                    })
                                    .on('mouseout', function (d, i) {
                                        d3.select(this).transition()
                                            .style('opacity', '1');	
                                    })
                                    .on('click', function (d, i) {
                                        checkWord(word);
                                    });
                            }
                        });
                    });
                });
            });

            function updateArtistTooltip() {
                console.log("Updating artist tooltip for " + currentArtist);
                let usesHTML = "";
                if (currentWord != "") {
                    let numUses = rapWords[currentWord][currentArtist];
                    let usesText = "\" " + numUses + " times.";
                    usesHTML += "Has used \"" + currentWord + usesText;
                } else {
                    usesHTML += "No valid word currently entered.";
                }
                let topWordsText = "</br><span style=\"font-weight: 900;\">Top Words</span></br>\t\""+topWords[currentArtist][0]+"\" ("+rapWords[topWords[currentArtist][0]][currentArtist]+" uses)</br>\t\""+topWords[currentArtist][1]+"\" ("+rapWords[topWords[currentArtist][1]][currentArtist]+" uses)</br>\t\""+topWords[currentArtist][2]+"\" ("+rapWords[topWords[currentArtist][2]][currentArtist]+" uses)";
                usesHTML += topWordsText;
                artistuses.html(usesHTML);
                artistname.html(rapperNames[currentArtist]);
                artistimg.attr('src', rapperPics[currentArtist]);
            }

            // This tooltip is used by ALL THE CHARTS
            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "greentooltip")
                .style("visibility", "hidden")
                .text("Tooltip");

            // THIS IS THE WORD SUGGESTION SECTION
            // Global Pairings Variables
            var wordArtistPairings = {};
            var wordTotalPairings = {};

            // Read through the suggestion data
            d3.json("artistWordPairings.json").then((data) => {
                wordArtistPairings = data;
            });

            d3.json("totalWordPairings.json").then((data) => {
                wordTotalPairings = data;
                UpdateSuggestions();
            });

            // Generate the chart svg
            let suggestSizeInfo = document.getElementById("wordsuggest").getBoundingClientRect();
            const suggestChartWidth = .75*suggestSizeInfo.width;
            const suggestChartHeight = .55*suggestSizeInfo.height;
            const suggestChartMargin = Math.max(.1*suggestSizeInfo.width, .05*suggestSizeInfo.height);
            const suggestChartsvg = d3.select("#suggestchart");
            suggestChartsvg.attr("viewBox", [0, 0, suggestSizeInfo.width, suggestSizeInfo.height]);
            const suggestChart = suggestChartsvg.append('g').attr('transform', `translate(${suggestChartMargin/1.5}, ${suggestChartMargin/5})`);

            var yScaleSuggest = d3.scaleLinear().range([suggestChartHeight, 0]).domain([0, 1]);
            var yAxisSuggest = suggestChart.append('g').attr('class', 'smallchartaxis');
            yAxisSuggest.call(d3.axisLeft(yScaleSuggest).tickValues([0,.2,.4, .6,.8,1]));
            const xScaleSuggest = d3.scaleBand().range([0, suggestChartWidth]).domain([0,1,2,3,4]).padding(0.4);
            const xAxisSuggest = suggestChart.append('g').attr('transform', `translate(0, ${suggestChartHeight})`).attr('class', 'chartaxis');
            xAxisSuggest.call(d3.axisBottom(xScaleSuggest));

            // Suggestion Chart Bars
            var suggestChartBars = [];
            for (var i = 0; i < 5; i++) {
                suggestChartBars.push(suggestChart.append('rect')
                    .attr('class', 'suggestchartbar')
                    .attr('x', xScaleSuggest(i))
                    .attr('y', yScaleSuggest(0))
                    .attr('width', xScaleSuggest.bandwidth())
                    .attr('height', suggestChartHeight - yScaleSuggest(0))
                    .on("mouseover", function(){return tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                );
            }

            // Updates the suggestions box to show word pairings of the input 'word'
            function UpdateSuggestions() {
                d3.select("#suggestsubtitle").html("Based off of word frequencies from all artists");
                let pairings = Object.keys(wordTotalPairings[currentWord]);
                let pairingValues = Object.values(wordTotalPairings[currentWord]);
                
                let max = Math.max.apply(Math, pairingValues);
                let yScaleMax = Math.min(max + .1, 1);
                yScaleSuggest = d3.scaleLinear().range([suggestChartHeight, 0]).domain([0, yScaleMax]);
                yAxisSuggest.call(d3.axisLeft(yScaleSuggest).tickValues([0,.2*yScaleMax,.4*yScaleMax, .6*yScaleMax,.8*yScaleMax,yScaleMax]));

                xScaleSuggest.domain(pairings).padding(0.4);
                xAxisSuggest.call(d3.axisBottom(xScaleSuggest));
                
                for (var index = 0; index < 5; index++) {
                    if (index < pairingValues.length) {
                        suggestChartBars[index].transition()
                            .duration(ANIMATION_DURATION)
                            .attr('class', 'suggestchartbar')
                            .attr('x', xScaleSuggest(pairings[index]))
                            .attr('y', yScaleSuggest(pairingValues[index]))
                            .attr('width', xScaleSuggest.bandwidth())
                            .attr('height', suggestChartHeight - yScaleSuggest(pairingValues[index]))
                        let frequency = (pairingValues[index]).toFixed(2);
                        suggestChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "blacktooltip").style("left",(event.pageX-50)+"px").text("Frequency: " + frequency);})
                    } else {
                        suggestChartBars[index].transition()
                            .duration(ANIMATION_DURATION)
                            .attr('y', yScaleSuggest(0))
                            .attr('height', suggestChartHeight - yScaleSuggest(0))
                        suggestChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "blacktooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    }
                }
            }

            function UpdateArtistSuggestions() {
                d3.select("#suggestsubtitle").html("Based off of word frequencies from <span class=\"green\">" + selectedArtist + "</span>");
                if (!(selectedArtist in wordArtistPairings[currentWord])) {
                    xScaleSuggest.domain([]);
                    xAxisSuggest.call(d3.axisBottom(xScaleSuggest));
                    for (var i = 0; i < 5; i++) {
                        suggestChartBars[i].transition()
                            .duration(ANIMATION_DURATION)
                            .attr('class', 'suggestchartbarartist')
                            .attr('y', yScaleSuggest(0))
                            .attr('height', suggestChartHeight - yScaleSuggest(0));
                        suggestChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "blacktooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    }
                    return;
                }

                let pairings = Object.keys(wordArtistPairings[currentWord][selectedArtist]);
                let pairingValues = Object.values(wordArtistPairings[currentWord][selectedArtist]);
                
                let max = Math.max.apply(Math, pairingValues);
                let yScaleMax = Math.min(max + .1, 1);
                yScaleSuggest = d3.scaleLinear().range([suggestChartHeight, 0]).domain([0, yScaleMax]);
                yAxisSuggest.call(d3.axisLeft(yScaleSuggest).tickValues([0,.2*yScaleMax,.4*yScaleMax, .6*yScaleMax,.8*yScaleMax,yScaleMax]));
                
                xScaleSuggest.domain(pairings).padding(0.4);
                xAxisSuggest.call(d3.axisBottom(xScaleSuggest));
                
                for (var index = 0; index < 5; index++) {
                    if (index < pairingValues.length) {
                        suggestChartBars[index].transition()
                            .duration(ANIMATION_DURATION)
                            .attr('class', 'suggestchartbarartist')
                            .attr('x', xScaleSuggest(pairings[index]))
                            .attr('y', yScaleSuggest(pairingValues[index]))
                            .attr('width', xScaleSuggest.bandwidth())
                            .attr('height', suggestChartHeight - yScaleSuggest(pairingValues[index]))
                        let frequency = (pairingValues[index]).toFixed(2);
                        suggestChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greentooltip").style("left",(event.pageX-50)+"px").text("Frequency: " + frequency);})
                    } else {
                        suggestChartBars[index].transition()
                            .duration(ANIMATION_DURATION)
                            .attr('class', 'suggestchartbarartist')
                            .attr('y', yScaleSuggest(0))
                            .attr('height', suggestChartHeight - yScaleSuggest(0))
                        suggestChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greentooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    }
                }
            }



            // THIS IS THE TEMPORAL DATA SECTION
            // Read through the temporal data
            d3.json("temporalwords.json").then((data) => {
                for (var i = 1982; i <= 2021; i++) {
                    let year = i.toString();
                    yearly_artist_counts[year] = data[year];
                }
            });

            d3.json("temporalwordstotals.json").then((data) => {
                for (var i = 1982; i <= 2021; i++) {
                    let year = i.toString();
                    yearly_totals[year] = data[year];
                }
            }, function(error, rows){
                console.log("Couldn't load the whole json maybe")
                console.log(error); 
            }).then(() => {console.log("finished reading temporal data!"); drawBars(currentWord)});

            // Generate the chart svg
            let sizeInfo = document.getElementById("wordusage").getBoundingClientRect();
            const chartWidth = .8*sizeInfo.width;
            const chartHeight = .65*sizeInfo.height;
            const chartMargin = Math.max(.1*chartWidth, .1*chartHeight);
            const chartsvg = d3.select("#usagechart");
            chartsvg.attr("viewBox", [0, 0, .95*sizeInfo.width, .8*sizeInfo.height]);
            const chart = chartsvg.append('g').attr('transform', `translate(${1.25*chartMargin}, ${chartMargin/2})`);

            // var zScale = d3.scaleLinear().range([chartHeight, 0]).domain([0, 100]);
            // var zAxis = chart.append('g').attr('transform', `translate(${chartWidth}, ${0})`);
            // zAxis.call(d3.axisRight(zScale));
            var yScale = d3.scaleLinear().range([chartHeight, 0]).domain([0, 100]);
            var yAxis = chart.append('g').attr('class', 'chartaxis');
            yAxis.call(d3.axisLeft(yScale));
            var every_year = []; for (var i = 1982; i <= 2021; i++) every_year.push(i);
            var every_other_year = []; for (var i = 1982; i <= 2021; i += 2) every_other_year.push(i);
            const xScale = d3.scaleBand().range([0, chartWidth]).domain(every_year).padding(0.4);
            const xAxis = chart.append('g').attr('transform', `translate(0, ${chartHeight})`).attr('class', 'chartaxis');
            xAxis.call(d3.axisBottom(xScale).tickValues(every_other_year)).selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-65)");;
            console.log(xAxis);

            // Total Chart Bars (All Artists)
            var chartBars = [];
            for (var i = 1982; i <= 2021; i++) {
                chartBars.push(chart.append('rect')
                    .attr('class', 'chartbar')
                    .attr('x', xScale(i))
                    .attr('y', yScale(0))
                    .attr('width', xScale.bandwidth())
                    .attr('height', chartHeight - yScale(0))
                    .on("mouseover", function(){return tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "blacktooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                );
            }
            // resetBars();

            // Artist Chart Bars (Selected Artist ONLY)
            var artistChartBars = [];
            for (var i = 1982; i <= 2021; i++) {
                artistChartBars.push(chart.append('rect')
                    .attr('class', 'artistchartbar')
                    .attr('x', xScale(i))
                    .attr('y', yScale(0))
                    .attr('width', xScale.bandwidth())
                    .attr('height', chartHeight - yScale(0))
                    .on("mouseover", function(){return tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greentooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                    .on("mouseout", function(){return tooltip.style("visibility", "hidden");})
                );
            }
            // resetArtistBars();

            // Chart Labels
            chartsvg.append('text')
                .attr('x', -(chartHeight / 2) - chartMargin)
                .attr('y', chartMargin / 2.4)
                .attr('transform', 'rotate(-90)')
                .attr('text-anchor', 'middle')
                .text('Word Usage by Artists (Count)')
            // chartsvg.append('text')
            //     .attr('x', chartHeight / 2 + chartMargin)
            //     .attr('y', -(chartWidth + 2*chartMargin))
            //     .attr('transform', 'rotate(90)')
            //     .attr('text-anchor', 'middle')
            //     .text('Word Usage by Selected Artist (Count)')
            chartsvg.append('text')
                .attr('x', chartWidth / 2 + chartMargin)
                .attr('y', chartHeight + 1.5*chartMargin)
                .attr('text-anchor', 'middle')
                .text('Time (Year)')

            var artistPath = chart.append('path');
            var artistLine = d3.line()
                .x(function(d) {console.log(d); return xScale(d.year); })
                .y(function(d) { return zScale(d.count); });
            //resetArtistLine();

            const usagesubtitle = d3.select("#usagesubtitle");

            function drawBars() {
                word_year_totals = []
                var maxCount = 0;
                for (var i = 1982; i <= 2021; i++) {
                    let year = i.toString();
                    console.log("drawing the bar for " + year);
                    if (currentWord in yearly_totals[year]) {
                        let count = yearly_totals[year][currentWord];
                        word_year_totals.push(count);
                        if (count > maxCount) maxCount = count;
                    } else word_year_totals.push(0);
                }

                yScale = d3.scaleLinear().range([chartHeight, 0]).domain([0, maxCount + Math.round(.1*maxCount)]);
                yAxis.call(d3.axisLeft(yScale));
                
                for (index in word_year_totals) {
                    chartBars[index].transition()
                        .duration(ANIMATION_DURATION)
                        .attr('y', yScale(word_year_totals[index]))
                        .attr('height', chartHeight - yScale(word_year_totals[index]))
                    let count = word_year_totals[index];
                    chartBars[index].on("mousemove", function(){return tooltip.attr("class", "greytooltip").style("top", (event.pageY-50)+"px").style("left",(event.pageX-50)+"px").text("Count: " + count);})
                }

                if (selectedArtist != "") {
                    drawArtistBars();
                }
                
                // Update Chart Subtitle
                usagesubtitle.html("How has the word \"" + currentWord + "\" been used over time?");
            }

            function resetBars() {
                console.log("Resetting bars");
                let zero_line = [];
                for (var i = 1982; i <= 2021; i++) zero_line.push(0);
                for (index in zero_line) {
                    chartBars[index].transition()
                        .duration(ANIMATION_DURATION)
                        .attr('y', yScale(0))
                        .attr('height', chartHeight - yScale(0))
                    chartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greytooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                }
            }

            function drawArtistBars() {
                console.log("Drawing artist bar for " + selectedArtist);
                artist_year_counts = [];
                for (var i = 1982; i <= 2021; i++) {
                    let year = i.toString();
                    let count = 0;
                    if (selectedArtist in yearly_artist_counts[year]) {
                        if (currentWord in yearly_artist_counts[year][selectedArtist]) {
                            count = yearly_artist_counts[year][selectedArtist][currentWord];
                        }
                    }
                    console.log(count);
                    artist_year_counts.push(count);
                }

                for (index in artist_year_counts) {
                    artistChartBars[index].transition()
                        .duration(ANIMATION_DURATION)
                        .attr('y', yScale(artist_year_counts[index]))
                        .attr('height', chartHeight - yScale(artist_year_counts[index]))
                    let count = artist_year_counts[index];
                    artistChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greentooltip").style("left",(event.pageX-50)+"px").text("Count: " + count);})
                }
            }

            function resetArtistBars() {
                console.log("Resetting artist bars");
                let zero_line = [];
                for (var i = 1982; i <= 2021; i++) zero_line.push(0);
                for (index in zero_line) {
                    artistChartBars[index].transition()
                        .duration(ANIMATION_DURATION)
                        .attr('y', yScale(0))
                        .attr('height', chartHeight - yScale(0))
                    artistChartBars[index].on("mousemove", function(){return tooltip.style("top", (event.pageY-50)+"px").attr("class", "greentooltip").style("left",(event.pageX-50)+"px").text("Tooltip");})
                }
            }

            // function drawArtistLine(word = currentWord) {
            //     console.log("Drawing artist line for " + selectedArtist);
            //     var maxArtistCount = 0;
            //     artist_year_counts = [];
            //     for (var i = 1982; i <= 2021; i++) {
            //         let year = i.toString();
            //         let count = 0;
            //         if (selectedArtist in yearly_artist_counts[year] && word in yearly_artist_counts[year][selectedArtist]) {
            //             count = yearly_artist_counts[year][selectedArtist][word];
            //             if (count > maxArtistCount) maxArtistCount = count;
            //         }
            //         artist_year_counts.push({year: i, count: count});
            //     }
            //     zScale = d3.scaleLinear().range([chartHeight, 0]).domain([0, maxArtistCount + Math.round(.1*maxArtistCount)]);
            //     // zAxis.attr('transform', `translate(${chartWidth}, ${0})`);
            //     zAxis.call(d3.axisRight(zScale));

            //     artistPath.data([artist_year_counts])
            //         .attr("class", "line")
            //         .transition()
            //         .duration(ANIMATION_DURATION)
            //         .attr('d', artistLine);
            // }

            // function resetArtistLine() {
            //     let zero_line = [];
            //     for (var i = 1982; i <= 2021; i++) {
            //         let year = i.toString();
            //         zero_line.push({year: i, count: 0});
            //     }
            //     artistPath.data([zero_line])
            //         .attr("class", "line")
            //         .transition()
            //         .duration(ANIMATION_DURATION)
            //         .attr('d', artistLine);
            // }

            // Handle typing from user
            var showNoWordsText = false;
            function handleType(event){
                checkWord(document.getElementById("wordtype").value);
            }

            function checkWord(word){
                let lowerCase = word.toLowerCase();
                document.getElementById("wordtype").value = lowerCase;
                let filtered = lowerCase.replace('\'', '');
                let words = filtered.split(" ");
                let lastWord = words[words.length - 1];
                console.log(words);
                for (var i = words.length - 1; i >= 0; i--) {
                    if (words[i] != "") {
                        lastWord = words[i];
                        break;
                    }
                }

                if (lastWord in rapWords) {
                    currentWord = lastWord;
                    console.log("This is one of the 1500 most popular words");
                    if (showNoWordsText) {
                        // Hide the no words available text
                        d3.select("#noword")
                            .transition()
                            .duration(ANIMATION_DURATION)
                            .style("opacity", 0);
                        showNoWordsText = false;
                    }
                    updateCircleSizes(lastWord);
                    updateArtistTooltip();
                    drawBars(lastWord);
                    if (selectedArtist != "") UpdateArtistSuggestions();
                    else UpdateSuggestions();
                } else {
                    if (!showNoWordsText) {
                        // Reveal the no words available text
                        if (word != "") {
                            showNoWordsText = true;
                            d3.select("#noword")
                                .transition()
                                .duration(ANIMATION_DURATION)
                                .style("opacity", 100);
                        }
                        // Reset all the circles
                        resetCircles();
                    } else {
                        if (word == "") {
                            showNoWordsText = false;
                            d3.select("#noword")
                                .transition()
                                .duration(ANIMATION_DURATION)
                                .style("opacity", 0);
                        }
                    }
                }
            }

            function updateCircleSizes(word) {
                // Get the max word count
                let maxWordCount = 0;
                for (var i = 0; i < rappers.length; i++) {
                    let rapper = rappers[i];
                    let rapperWordCount = rapWords[word][rapper];
                    if (rapperWordCount > maxWordCount) maxWordCount = rapperWordCount;
                }

                // Initialize all bins
                let numBins = 25;
                let binSize = maxWordCount/numBins;
                let rapperBins = {};

                // Using images
                let svgWidth = .9*document.getElementById("viz").offsetWidth;
                let svgHeight = .9*document.getElementById("viz").offsetHeight;
                let minDim = Math.min(svgHeight, svgWidth);
                let margin = 0;
                let diff = (minDim - 2*margin)/9;
                for (var i = 0; i < rappers.length; i++) {
                    let rapper = rappers[i];
                    if (rapper != undefined) {
                        let bin = Math.round(rapWords[word][rapper]/binSize);
                        let size = (.4 + (bin/numBins*.5)) * diff;
                        let x = margin + diff*(i%10) + (diff - size)/2;
                        let y = margin + diff*Math.floor(i/10) + (diff - size)/2;
                        if (svgWidth > svgHeight) x += .5*(svgWidth - svgHeight);
                        else y += .5*(svgHeight - svgWidth);
                        rapperCircles[rapper].transition()
                            .duration(ANIMATION_DURATION)
                            .attr("x", x)
                            .attr("y", y)
                            .attr("height", size)
                            .attr("width", size);
                    }
                }
            }

            function resetCircles() {
                let svgWidth = .9*document.getElementById("viz").offsetWidth;
                let svgHeight = .9*document.getElementById("viz").offsetHeight;
                let minDim = Math.min(svgHeight, svgWidth);
                let margin = 0;
                let diff = (minDim - 2*margin)/9;
                let size = .75*diff;
                for (var i = 0; i < rappers.length; i++) {
                    let rapper = rappers[i];
                    if (rapper != undefined) {
                        let x = margin + diff*(i%10) + .125*diff;
                        let y = margin + diff*Math.floor(i/10) + .125*diff;
                        if (svgWidth > svgHeight) x += .5*(svgWidth - svgHeight);
                        else y += .5*(svgHeight - svgWidth);
                        rapperCircles[rapper].transition()
                            .duration(ANIMATION_DURATION)
                            .attr("x", x)
                            .attr("y", y)
                            .attr("height", size)
                            .attr("width", size);
                    }
                }
            }

            function selectArtist() {
                updateArtistTooltip();
                drawArtistBars();
                UpdateArtistSuggestions();
            }

            function deselectArtist() {
                resetArtistBars();
                UpdateSuggestions();
            }
        </script>
    </body>
</html>
